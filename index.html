<script>
  const CONFIG = {
    APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwoTd89Rjf6MxBqDaXe8t-6aH82JrooGZseQ4Ub_0FoL81cafaxyFAntC41tKO68-pT/exec',
    USAR_DATOS_EJEMPLO: false,
    SLA_OBJETIVO: 90
  };

  // Datos de ejemplo (se mantienen)
  const DATOS_EJEMPLO = [
    { OrdenID: '2000015991515', Canal: 'CHEMESCASACENTRAL', FechaHoraIngreso: '2026-01-07 14:30:00', FechaHoraDespacho: '2026-01-08 10:15:00', DiaLogisticoIngreso: '2026-01-07', DiaLogisticoDespacho: '2026-01-07', Estado: 'DESPACHADO', HorasTranscurridas: 19.75, DiasTranscurridos: 0 },
    { OrdenID: '2000015991517', Canal: 'CHEMESCASACENTRAL', FechaHoraIngreso: '2026-01-07 16:20:00', FechaHoraDespacho: null, DiaLogisticoIngreso: '2026-01-07', DiaLogisticoDespacho: null, Estado: 'PENDIENTE', HorasTranscurridas: 28.5, DiasTranscurridos: 1 },
    { OrdenID: '78542', Canal: 'PrestaShop_itst', FechaHoraIngreso: '2026-01-07 09:15:00', FechaHoraDespacho: '2026-01-07 16:45:00', DiaLogisticoIngreso: '2026-01-06', DiaLogisticoDespacho: '2026-01-07', Estado: 'DESPACHADO', HorasTranscurridas: 7.5, DiasTranscurridos: 0 },
    { OrdenID: 'BNA-1002', Canal: 'Tienda_BNA', FechaHoraIngreso: '2026-01-07 12:30:00', FechaHoraDespacho: '2026-01-08 09:00:00', DiaLogisticoIngreso: '2026-01-06', DiaLogisticoDespacho: '2026-01-07', Estado: 'DESPACHADO', HorasTranscurridas: 20.5, DiasTranscurridos: 0 }
  ];

  var chartSLA, chartAging, chartCanales;

  const COLORES = {
    canales: ['#f97316', '#a78bfa', '#60a5fa', '#f472b6'],
    aging: ['#2dd4bf', '#fbbf24', '#f97316', '#ef4444'],
    sla: { ok: '#2dd4bf', warning: '#fbbf24', danger: '#ef4444' }
  };

  // -----------------------------
  // Helpers: parseo y normalizaciÃ³n
  // -----------------------------
  function toNumberAny(x) {
    if (x === null || x === undefined || x === '') return null;
    if (typeof x === 'number') return x;
    const s = String(x).trim().replace(',', '.');
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  function parseDateSafe(value) {
    if (!value) return null;
    if (value instanceof Date) return isNaN(value.getTime()) ? null : value;

    let s = String(value).trim().replace(/"/g, '');
    if (!s || s.toUpperCase() === 'NULL') return null;

    // ISO o "YYYY-MM-DD HH:mm:ss"
    if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
      // normalizar espacio a 'T'
      if (s.includes(' ') && !s.includes('T')) s = s.replace(' ', 'T');
      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }

    // Formato con barras: dd/mm/yyyy o m/d/yyyy (+ hora)
    // HeurÃ­stica:
    // - si el primer nÃºmero > 12 => D/M/Y
    // - si el segundo > 12 => M/D/Y
    // - si ambos <= 12 => asumimos D/M/Y (mÃ¡s comÃºn en AR) PERO:
    //   si tu data viene de CSV/Excel puede ser M/D/Y; por eso usamos la heurÃ­stica arriba.
    const parts = s.split(' ');
    const ab = parts[0].split('/');
    if (ab.length === 3) {
      const a = parseInt(ab[0], 10);
      const b = parseInt(ab[1], 10);
      const yyyy = parseInt(ab[2], 10);

      let day, month;
      if (a > 12 && b <= 12) { day = a; month = b; }
      else if (b > 12 && a <= 12) { month = a; day = b; }
      else {
        // ambiguo (1/9/2026): acÃ¡ podÃ©s forzar MDY si tu fuente viene asÃ­
        // En tu caso vimos inversiÃ³n, asÃ­ que forzamos MDY cuando es ambiguo:
        month = a; day = b;
      }

      let hh = 0, mi = 0, ss = 0;
      if (parts[1]) {
        const t = parts[1].split(':');
        hh = parseInt(t[0] || '0', 10);
        mi = parseInt(t[1] || '0', 10);
        ss = parseInt(t[2] || '0', 10);
      }

      const d = new Date(yyyy, month - 1, day, hh, mi, ss);
      return isNaN(d.getTime()) ? null : d;
    }

    return null;
  }

  function parseDateOnly(value) {
    const d = parseDateSafe(value);
    if (!d) return null;
    return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0);
  }

  function normalizeRow(r) {
    const out = { ...r };

    out.HorasTranscurridas = toNumberAny(out.HorasTranscurridas);
    out.DiasTranscurridos = toNumberAny(out.DiasTranscurridos);

    // normalizar fechas a Date internamente
    out._Ingreso = parseDateSafe(out.FechaHoraIngreso);
    out._Despacho = parseDateSafe(out.FechaHoraDespacho);

    out._DiaLogIngreso = parseDateOnly(out.DiaLogisticoIngreso);
    out._DiaLogDespacho = parseDateOnly(out.DiaLogisticoDespacho);

    return out;
  }

  function normalizeData(arr) {
    return (arr || []).map(normalizeRow).filter(x => x && x.OrdenID);
  }

  // SLA 24h segÃºn dÃ­a logÃ­stico 13:01 â†’ 13:00
  // Cumple si: FechaHoraDespacho <= (DiaLogisticoIngreso + 1 dÃ­a) a las 13:00
  function cumpleSLA24(row) {
    if (!row || row.Estado !== 'DESPACHADO') return false;
    if (!row._Despacho || !row._DiaLogIngreso) return false;

    const deadline = new Date(row._DiaLogIngreso.getFullYear(), row._DiaLogIngreso.getMonth(), row._DiaLogIngreso.getDate(), 13, 0, 0);
    deadline.setDate(deadline.getDate() + 1); // +1 dÃ­a a las 13:00

    return row._Despacho.getTime() <= deadline.getTime();
  }

  // -----------------------------
  // Formateadores UI
  // -----------------------------
  function formatNumber(num) { return num.toLocaleString('es-AR'); }

  function formatHoras(horas) {
    if (horas === null || horas === undefined) return '-';
    if (horas < 24) return Math.round(horas) + 'hs';
    const dias = Math.floor(horas / 24);
    const hs = Math.round(horas % 24);
    return dias + 'd ' + hs + 'hs';
  }

  function formatFecha(fecha) {
    const d = parseDateSafe(fecha);
    if (!d) return '-';
    return d.toLocaleDateString('es-AR') + ' ' + d.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
  }

  function getCanalIcon(canal) {
    const icons = {
      'CHEMESCASACENTRAL': 'ðŸ ',
      'PrestaShop_itst': 'ðŸ›ï¸',
      'Tienda_BNA': 'ðŸ¦',
      'Mercado Libre': 'ðŸ›’',
      'Otros Canales': 'ðŸ“¦'
    };
    return icons[canal] || 'ðŸ“¦';
  }

  function getAlertaIcon(horas) {
    if (horas <= 24) return { icon: 'ðŸŸ¢', class: 'text-teal-400', label: 'En tiempo' };
    if (horas <= 48) return { icon: 'ðŸŸ¡', class: 'text-amber-400', label: 'AtenciÃ³n' };
    if (horas <= 72) return { icon: 'ðŸŸ ', class: 'text-orange-400', label: 'Urgente' };
    return { icon: 'ðŸ”´', class: 'text-red-400 animate-pulse-slow', label: 'CrÃ­tico' };
  }

  // -----------------------------
  // CÃ¡lculos
  // -----------------------------
  function calcularMetricas(datos) {
    const total = datos.length;
    const despachados = datos.filter(d => d.Estado === 'DESPACHADO');
    const pendientes = datos.filter(d => d.Estado === 'PENDIENTE');

    const despachadosEn24hs = despachados.filter(d => cumpleSLA24(d)).length;
    const sla = despachados.length > 0 ? (despachadosEn24hs / despachados.length * 100) : 0;

    const tiempoPromedio = despachados.length > 0
      ? despachados.reduce((sum, d) => sum + (d.HorasTranscurridas || 0), 0) / despachados.length
      : 0;

    const aging = {
      '0-24hs': pendientes.filter(d => (d.HorasTranscurridas ?? 999999) <= 24).length,
      '24-48hs': pendientes.filter(d => d.HorasTranscurridas > 24 && d.HorasTranscurridas <= 48).length,
      '48-72hs': pendientes.filter(d => d.HorasTranscurridas > 48 && d.HorasTranscurridas <= 72).length,
      '+72hs': pendientes.filter(d => d.HorasTranscurridas > 72).length
    };

    return { total, despachados: despachados.length, pendientes: pendientes.length, sla, tiempoPromedio, aging };
  }

  function calcularPorCanal(datos) {
    const canales = {};
    datos.forEach(d => {
      if (!canales[d.Canal]) {
        canales[d.Canal] = { ingresaron: 0, despachados: 0, pendientes: 0, tiempos: [], en24hs: 0 };
      }
      canales[d.Canal].ingresaron++;

      if (d.Estado === 'DESPACHADO') {
        canales[d.Canal].despachados++;
        canales[d.Canal].tiempos.push(d.HorasTranscurridas || 0);
        if (cumpleSLA24(d)) canales[d.Canal].en24hs++;
      } else {
        canales[d.Canal].pendientes++;
      }
    });

    return Object.entries(canales).map(([nombre, data]) => ({
      nombre,
      ingresaron: data.ingresaron,
      despachados: data.despachados,
      pendientes: data.pendientes,
      tiempoPromedio: data.tiempos.length > 0 ? data.tiempos.reduce((a, b) => a + b, 0) / data.tiempos.length : 0,
      sla: data.despachados > 0 ? (data.en24hs / data.despachados * 100) : 0
    })).sort((a, b) => b.ingresaron - a.ingresaron);
  }

  // -----------------------------
  // Render
  // -----------------------------
  function renderMetricas(metricas) {
    const items = [
      { titulo: 'Ingresaron', valor: metricas.total, subtitulo: 'Ãšltimos 30 dÃ­as', gradient: 'from-blue-500 to-blue-600', textColor: 'text-blue-400', icon: 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4' },
      { titulo: 'Despachados', valor: metricas.despachados, subtitulo: Math.round(metricas.despachados / metricas.total * 100) + '% del total', gradient: 'from-teal-500 to-teal-600', textColor: 'text-teal-400', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' },
      { titulo: 'Pendientes', valor: metricas.pendientes, subtitulo: 'Sin despachar', gradient: 'from-pink-500 to-pink-600', textColor: 'text-pink-400', icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' },
      { titulo: 'Tiempo Prom.', valor: formatHoras(metricas.tiempoPromedio), subtitulo: 'Ingreso â†’ Despacho', gradient: 'from-orange-500 to-orange-600', textColor: 'text-orange-400', icon: 'M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0' },
      { titulo: 'SLA 24hs', valor: metricas.sla.toFixed(1) + '%', subtitulo: metricas.sla >= CONFIG.SLA_OBJETIVO ? 'âœ“ Cumple objetivo' : 'âš  Bajo objetivo', gradient: metricas.sla >= CONFIG.SLA_OBJETIVO ? 'from-teal-500 to-teal-600' : 'from-amber-500 to-amber-600', textColor: metricas.sla >= CONFIG.SLA_OBJETIVO ? 'text-teal-400' : 'text-amber-400', icon: 'M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z' }
    ];

    document.getElementById('metricas').innerHTML = items.map((m, i) =>
      '<div class="bg-dark-800 rounded-2xl border border-dark-700 hover:border-dark-600 transition-all overflow-hidden animate-fade" style="animation-delay:' + (i * 50) + 'ms">' +
      '<div class="h-1 bg-gradient-to-r ' + m.gradient + '"></div><div class="p-5">' +
      '<div class="flex items-center justify-between mb-3"><span class="text-sm font-medium text-slate-400 uppercase tracking-wide">' + m.titulo + '</span>' +
      '<div class="p-2 rounded-xl bg-gradient-to-br ' + m.gradient + ' text-white shadow-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="' + m.icon + '"/></svg></div></div>' +
      '<div class="text-3xl font-bold text-white mb-1">' + m.valor + '</div><div class="text-sm ' + m.textColor + '">' + m.subtitulo + '</div></div></div>'
    ).join('');
  }

  function renderDatos(datos) {
    const metricas = calcularMetricas(datos);
    const porCanal = calcularPorCanal(datos);

    renderMetricas(metricas);
    renderGraficos(metricas, porCanal);
    renderTablaPendientes(datos);
    renderTablaCanales(porCanal);

    document.getElementById('ultimaActualizacion').textContent =
      'Ãšltima actualizaciÃ³n: ' + new Date().toLocaleString('es-AR');
  }

  // -----------------------------
  // GrÃ¡ficos (se conserva tu lÃ³gica)
  // -----------------------------
  function renderGraficos(metricas, porCanal) {
    if (chartSLA) chartSLA.destroy();
    if (chartAging) chartAging.destroy();
    if (chartCanales) chartCanales.destroy();
    Chart.defaults.color = '#94a3b8';

    const slaColor = metricas.sla >= CONFIG.SLA_OBJETIVO ? COLORES.sla.ok : metricas.sla >= 70 ? COLORES.sla.warning : COLORES.sla.danger;
    document.getElementById('slaValue').textContent = metricas.sla.toFixed(1) + '%';
    document.getElementById('slaValue').className =
      'text-4xl font-bold ' + (metricas.sla >= CONFIG.SLA_OBJETIVO ? 'text-teal-400' : metricas.sla >= 70 ? 'text-amber-400' : 'text-red-400');

    chartSLA = new Chart(document.getElementById('chartSLA').getContext('2d'), {
      type: 'doughnut',
      data: { datasets: [{ data: [metricas.sla, 100 - metricas.sla], backgroundColor: [slaColor, '#334155'], borderWidth: 0 }] },
      options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false }, tooltip: { enabled: false } } }
    });

    chartAging = new Chart(document.getElementById('chartAging').getContext('2d'), {
      type: 'bar',
      data: {
        labels: ['0-24hs', '24-48hs', '48-72hs', '+72hs'],
        datasets: [{
          data: [metricas.aging['0-24hs'], metricas.aging['24-48hs'], metricas.aging['48-72hs'], metricas.aging['+72hs']],
          backgroundColor: COLORES.aging,
          borderRadius: 6
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#334155' } }, y: { grid: { display: false } } } }
    });

    chartCanales = new Chart(document.getElementById('chartCanales').getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: porCanal.map(c => c.nombre),
        datasets: [{ data: porCanal.map(c => c.despachados), backgroundColor: COLORES.canales, borderWidth: 0 }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 }, color: '#94a3b8' } } } }
    });
  }

  function renderTablaPendientes(datos) {
    const pendientes = datos.filter(d => d.Estado === 'PENDIENTE')
      .sort((a, b) => (b.HorasTranscurridas || 0) - (a.HorasTranscurridas || 0));

    document.getElementById('pendientesCount').textContent = pendientes.length + ' pedidos';

    document.getElementById('tablaPendientes').innerHTML = pendientes.length === 0
      ? '<tr><td colspan="6" class="px-5 py-8 text-center text-teal-400">ðŸŽ‰ Â¡No hay pedidos pendientes!</td></tr>'
      : pendientes.map(p => {
        const alerta = getAlertaIcon(p.HorasTranscurridas || 0);
        const dias = p.DiasTranscurridos || Math.floor((p.HorasTranscurridas || 0) / 24);
        return '<tr class="hover:bg-dark-700/50 transition-colors">' +
          '<td class="px-5 py-3 text-white font-mono text-xs">' + p.OrdenID + '</td>' +
          '<td class="px-5 py-3 text-slate-300">' + getCanalIcon(p.Canal) + ' ' + p.Canal + '</td>' +
          '<td class="px-5 py-3 text-slate-400 text-sm">' + formatFecha(p.FechaHoraIngreso) + '</td>' +
          '<td class="px-5 py-3 text-right font-semibold ' + alerta.class + '">' + dias + 'd</td>' +
          '<td class="px-5 py-3 text-right font-semibold ' + alerta.class + '">' + formatHoras(p.HorasTranscurridas) + '</td>' +
          '<td class="px-5 py-3 text-center"><span title="' + alerta.label + '">' + alerta.icon + '</span></td>' +
          '</tr>';
      }).join('');
  }

  function renderTablaCanales(porCanal) {
    document.getElementById('tablaCanales').innerHTML = porCanal.map(c => {
      const slaClass = c.sla >= CONFIG.SLA_OBJETIVO ? 'text-teal-400' : c.sla >= 70 ? 'text-amber-400' : 'text-pink-400';
      return '<tr class="hover:bg-dark-700/50 transition-colors">' +
        '<td class="px-5 py-3 text-white font-semibold">' + getCanalIcon(c.nombre) + ' ' + c.nombre + '</td>' +
        '<td class="px-5 py-3 text-right text-slate-300">' + formatNumber(c.ingresaron) + '</td>' +
        '<td class="px-5 py-3 text-right text-teal-400">' + formatNumber(c.despachados) + '</td>' +
        '<td class="px-5 py-3 text-right ' + (c.pendientes > 0 ? 'text-pink-400 font-semibold' : 'text-slate-500') + '">' + formatNumber(c.pendientes) + '</td>' +
        '<td class="px-5 py-3 text-right text-orange-400">' + formatHoras(c.tiempoPromedio) + '</td>' +
        '<td class="px-5 py-3 text-right font-semibold ' + slaClass + '">' + c.sla.toFixed(1) + '%</td>' +
        '</tr>';
    }).join('');
  }

  async function cargarDatos() {
    const btn = document.getElementById('btnActualizar');
    const icon = document.getElementById('iconRefresh');
    const errorDiv = document.getElementById('errorMsg');

    btn.disabled = true;
    icon.classList.add('animate-spin');
    errorDiv.classList.add('hidden');

    try {
      let datos;
      if (CONFIG.USAR_DATOS_EJEMPLO) {
        await new Promise(r => setTimeout(r, 200));
        datos = DATOS_EJEMPLO;
      } else {
        const response = await fetch(CONFIG.APPS_SCRIPT_URL);
        if (!response.ok) throw new Error('Error HTTP');
        const json = await response.json();
        datos = json.data || json;
      }

      datos = normalizeData(datos);
      renderDatos(datos);

    } catch (error) {
      console.error('Error:', error);
      document.getElementById('errorText').textContent = 'Error al cargar los datos.';
      errorDiv.classList.remove('hidden');
    } finally {
      btn.disabled = false;
      icon.classList.remove('animate-spin');
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('btnActualizar');
  if (btn) {
    btn.addEventListener('click', cargarDatos);
  } else {
    console.warn('btnActualizar no encontrado en el DOM');
  }

  cargarDatos();
  setInterval(cargarDatos, 5 * 60 * 1000);
});

</script>
